# PLC Advanced AutoLab Framework

![Python](https://img.shields.io/badge/python-3.6%2B-blue.svg)
[![PLC](https://img.shields.io/badge/PLC-Panasonic%20FP%20Series-green.svg)](https://www3.panasonic.biz/ac/e/fasys/plc/)
![PLC Structured Text](https://img.shields.io/badge/PLC-Structured%20Text-yellow.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)




## 🔥 项目亮点：为何这个仓库值得关注？

这不是一个简单的“Hello World”示例。这是一个**在生产环境中验证过的、完整、健壮的工业控制系统核心模块**。它完美诠释了如何将复杂的软件工程思想（状态机、队列、模块化）应用于传统的工业自动化领域。

**如果你想知道“真正的工业控制代码”长什么样，这就是一个绝佳范本。**

**本项目依托于松下FP系列PLC，对于其他品牌PLC进行响应改造后也可使用。**

## 🎯 项目背景与解决的问题

在清华大学实验室的自动化科研平台项目中，我们面临一个核心挑战：**如何让上位机（Python/PC）安全、可靠、异步地控制多台机械臂和更多硬件设备（如伺服电机，步进电机，传感器），并处理复杂的通信超时、重试与状态同步？**

直接使用梯形图进行复杂的协议解析和状态管理将导致代码臃肿且难以维护。本项目使用 **结构化文本（ST）** 在松下FP系列PLC上实现了一个**工业级的解决方案**，将控制逻辑的复杂性封装在清晰的软件架构中。

## 🏗️ 系统架构与核心设计思想

### 1. 清晰的层次化架构
```
┌─────────────────────────────────────────┐
│           应用层:  指令队列与调度           │ ◀─ AI调度接口
├─────────────────────────────────────────┤
│           核心层：状态机与业务逻辑           │
├─────────────────────────────────────────┤
│通信层：TCP/UDP/串口/Ethercat 统一通信适配器  │
└─────────────────────────────────────────┘

```

### 2. 核心功能模块

- **`FB_RobotArmController` (功能块)**：
  - **工业级状态机**：实现 `发送指令 → 等待响应 → 查询状态 → 完成/错误` 的全流程管理。
  - **完善的容错机制**：内置指令级超时、总超时、可配置重试次数。
  - **详尽的错误码体系**：涵盖连接丢失、发送失败、响应错误、超时等所有异常场景。

- **`Queue` (功能块)**：
  - **线程安全的循环队列**：实现指令的缓冲与管理，支持入队（PUSH）、出队（POP）、清空（CLEAR）。
  - **防止指令拥堵或丢失**：为多任务调度打下基础。

- **TCP通信层**：
  - 封装松下PLC的 `F159_MTRN` 等底层指令，提供简洁的 `tcp_send` / `tcp_recv` 接口。
  - 处理字节序、缓冲区管理等底层细节。

- **日志系统**：
  - 实时将关键状态和错误信息通过TCP发送至上位机，极大简化了现场调试和故障排查。

## 💻 代码质量与工程实践

这份代码体现了高级软件工程师在嵌入式/工业领域的思维方式：

1.  **模块化与解耦**：通信、控制、队列、日志职责分离，修改任意模块不影响其他部分。
2.  **防御式编程**：对输入参数、通信状态、缓冲区边界进行了严格检查。
3.  **可维护性**：使用常量而非魔数，关键逻辑配有详细注释。
4.  **可观测性**：通过日志系统，系统内部状态对外部透明。

**特别值得一提的是注释中记录的“实战经验”**，例如网络缓冲区的配置陷阱、特定指令的内存行为等，这些知识在任何官方手册中都难以找到，是真正从调试中获得的宝贵财富。

## 🚀 快速开始

### 环境要求
- **PLC硬件**：松下 FP 系列 (如 FP7)
- **编程软件**：松下 FPWIN GR 7 / FPWIN Pro 7
- **通信**：PLC已配置以太网，并开放用户通信端口。

### 部署步骤
1.  将 `项目.asc` 中的所有 `POU` 导入您的工程。
4.  配置上位机连接至PLC的相应端口，并实现简单的TCP服务器以接收日志和响应指令。可参考server目录下的log接收服务器udp_log_server.py 和机械臂仿真服务器robot_simu_server_8001.py

## 📖 适用场景与启发

- **学习工业ST编程**：作为从梯形图迈向结构化文本的进阶案例。
- **构建可靠控制系统**：参考其状态机和错误处理设计，应用于AGV、生产线、测试设备等。
- **科研平台集成**：作为连接“智能算法”与“物理执行器”的可靠桥梁，特别适用于自动化实验室、机器人研究。
- **架构参考**：展示如何在资源受限的PLC环境中，应用经典的软件架构模式。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request。对于工业控制领域的优化建议或实战经验分享，尤其感谢。

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件。

---

**作者**：[@Yin Shiqiu](https://github.com/yinliangying) | **背景**：清华大学化工系实验室核心研发工程师，致力于AI与自动化系统的融合。

**思考**：在工业4.0和智能制造的浪潮下，传统的PLC编程不应止步于梯形图。将软件工程的优秀实践引入工业控制领域，是提升可靠性、可维护性和开发效率的必经之路。本项目是这一理念的一次具体实践。

---

**⭐ 如果这个项目对您有启发，请点个Star！它代表了工业自动化代码应有的专业度。**






